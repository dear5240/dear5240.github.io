# 5. FM相关应用

## 5.1. 概述

AC696X:

- FM调频立体声接收系统，覆盖范围：76-108MHz，步进50/100KHz(与蓝牙不可同时用)



通常FM接收功能，分内置FM和外置FM两种，内置FM使用杰理芯片内部的射频模块进行数据的解调，最后将数据发送到DAC模块，从而输出声音，外置FM使用类似于RDA5807等芯片，经过该芯片解调后输出到DAC，杰理方案通过LINEIN/AUX的模块采集输出到DAC。



FM功能相应的代码配置，在各板级头文件件中，如`apps\soundbox\board\br23\board_ac695x_demo\board_ac695x_demo_cfg.h`

```
//*********************************************************************************//
//                                  fm 配置                                     //
//*********************************************************************************//
#define TCFG_FM_ENABLE                            TCFG_APP_FM_EN // fm 使能
#define TCFG_FM_INSIDE_ENABLE                    ENABLE
#define TCFG_FM_RDA5807_ENABLE                    DISABLE //需要使能软件IIC模块
#define TCFG_FM_BK1080_ENABLE                    DISABLE //需要使能软件IIC模块
#define TCFG_FM_QN8035_ENABLE                    DISABLE //需要使能软件IIC模块

#define TCFG_FMIN_LADC_IDX                1                // linein使用的ladc通道，对应ladc_list
#define TCFG_FMIN_LR_CH                    AUDIO_LIN1_LR
#define TCFG_FM_INPUT_WAY               LINEIN_INPUT_WAY_ANALOG//用于配置FM的输入来源。如模拟，则是内置FM模块，如是ADC则是使用LINEIN模块采集

#if (TCFG_FM_INSIDE_ENABLE && TCFG_FM_ENABLE)
#if (((TCFG_USER_TWS_ENABLE) || (RECORDER_MIX_EN) || (TCFG_MIC_EFFECT_ENABLE)))
#define TCFG_CODE_RUN_RAM_FM_MODE                     DISABLE_THIS_MOUDLE      //FM模式 代码跑ram，用于减少访问内部FLASH的高频干扰，增加FM收音灵敏度
#else
#define TCFG_CODE_RUN_RAM_FM_MODE                     ENABLE_THIS_MOUDLE      //FM模式 代码跑ram，用于减少访问内部FLASH的高频干扰，增加FM收音灵敏度
#endif
#else
#define TCFG_CODE_RUN_RAM_FM_MODE                     DISABLE_THIS_MOUDLE     //FM模式 代码跑ram，用于减少访问内部FLASH的高频干扰，增加FM收音灵敏度
#endif /*(TCFG_FM_INSIDE_ENABLE && TCFG_FM_ENABLE)*/

#if (TCFG_CODE_RUN_RAM_FM_MODE && TCFG_UI_ENABLE)
#undef TCFG_LED7_RUN_RAM
#define TCFG_LED7_RUN_RAM                     ENABLE_THIS_MOUDLE     //led7跑ram 不屏蔽中断(需要占据2k附近ram)
#endif /*(TCFG_CODE_RUN_RAM_FM_MODE && TCFG_UI_ENABLE)*/

//*********************************************************************************//
//                                  fm emitter 配置                                     //
//*********************************************************************************//
#define TCFG_APP_FM_EMITTER_EN                  DISABLE_THIS_MOUDLE
#define TCFG_FM_EMITTER_INSIDE_ENABLE            DISABLE
#define TCFG_FM_EMITTER_AC3433_ENABLE            DISABLE
#define TCFG_FM_EMITTER_QN8007_ENABLE            DISABLE
#define TCFG_FM_EMITTER_QN8027_ENABLE            DISABLE
```



## 5.2. 代码

- FM接收：

在`app_main.c`中会进入到`app_fm_task`，该模式用于FM接收功能。

应用端开发重点关注` ..\apps\soundbox\task_manager\fm`文件夹下的源文件，

其中

`fm.c`是主要用于接收按键消息，设备消息，公共消息，根据相应的消息进行处理

`fm_api.c`提供了频道搜索，频道检索，频道切换，频道增加删除，静音等api接口

`fm_rw.c`提供频点存储，读取，检查的api接口

由于FM接收功能可以通过内置FM模块或外置FM芯片来实现，需要通过`fm_manage.c`来管理各类的驱动代码。

路径 ` ..\apps\common\device\fm` 文件夹下有包含各类芯片的驱动，

`fm_manage.c`用于管理FM驱动驱动代码，rda5807，qn8035，bk1080，fm_inside是各类驱动的文件夹



## 5.3. FM接收

### 5.3.1. 内置FM搜台软件调试方法

1. 用认可的收音机/对比样机先搜一次台，记录下当前位置的清晰台(人声清晰/基本没有雪花声)对应频点

不同天气、不同时间段、不同位置、实际收台效果会有差别，在调试 FM 时要有对比样机做参考，且使用整机测试；（拿笔记录下对比样机的每个电台频点，再记录下样机能收到的每个电台的频点，具体分析是那些频点没有收到）

1. 确定FM内部AGC的值 值的设定可参考以下规则:(有放大，设最小；没放大，设最大)
   - 加放大电路：建议把AGC的值设置到最小，放大倍数由外部放大电路决定。
   - 没有放大电路：首先把AGC的值设置到最大；然后观察是否存在串台现象。若有串台现象就需要降低内部AGC的值，没有则可以使用最大值。

AC696/AC695 AGC的值(范围：-96 ~ -1)

```
#define FMSCAN_AGC           -55 //AGC阈值  -55左右
```

1. 有条件可以用信号发生器，可以测试一下收音的灵敏度/信噪比。一般灵敏度在 15dBu 以下的，收台效果都比较好。
1. 对比实际搜台效果。根据前面记录的清晰台频点，对比实际样机少了哪些频点并在样机商听下少掉的频点是否清晰。(例如：你发现88.8MHz这个频点的清晰台没有搜到，就把样机频点设到88.8MHz，听样机的声音。如果声音清晰――可修改搜台判断阈值。如果声音不清晰，软件就没办法了)

备注：在实际调试中，一般只需把清晰台基本搜出来既可，不用太关注不清晰台的数量。因为假台可以通过修改判断阈值进行增加或者减少。

1. 搜台阈值修改

主要修改以下三个参数：

- MSCAN_CNR: 台清晰该值越大，调大该值可以过滤大部分假台。

  FMSCAN_P_DIFFER : 全部台 power 都需要大于该值。agc_noise_avg 较高时要大于 FMSCAN_P_DIFFER+1

  FMSCAN_N_DIFFER ：当台不是十分清晰时，需要 noise 差异值在这个范围之间

- 参数说明

```
FMSCAN_SEEK_CNT_MIN         //一段时间内的中频波形最小过零点数
FMSCAN_SEEK_CNT_MAX         //一段时间内的中频波形最大过零点数
FMSCAN_960_CNR              //24M 晶振 96M 谐波的基础 CNR
FMSCAN_1080_CNR             //芯片内部 12M 时钟源 108M 谐波的基础 CNR
FMSCAN_AGC agc_noise_avg    //超过此值，自动降低 FM 内部增益，从最高增益开始降
FMSCAN_ADD_DIFFER agc_noise_avg //低于此值，判定会增加 FMSCAN_N_DIFFER，降低假台率
FMSCAN_CNR                  //信号在中频上的载噪比
FMSCAN_P_DIFFER             //当前频点最小 power 减 上一个频点最大 power
FMSCAN_N_DIFFER             //当前频点最小 noise 减 上一个频点最小 noise
FM_IF                       //FM 听台中频
```

- 真台判定条件

①FMSCAN_SEEK_CNT_MIN <= seek_cnt <= FMSCAN_SEEK_CNT_MAX

②非谐波频点： FMSCAN_CNR <= cnr，谐波频点： FMSCAN_CNR + FMSCAN_960_CNR <= cnr，108M 同理        

③当 FMSCAN_ADD_DIFFER <= agc_noise_avg 时： FMSCAN_P_DIFFER + 1 <= power_differ FMSCAN_N_DIFFER 无效

​     当 FMSCAN_ADD_DIFFER > agc_noise_avg 时： FMSCAN_P_DIFFER <= power_differ (-)FMSCAN_N_DIFFER <= noise_differ <=(+) FMSCAN_N_DIFFER

**注意**:软件只能把搜索到的清晰台给筛选出来，不能把一个不清晰/串台的台变成清晰。

以上seek_cnt，cnr，agc_noise_avg，power_differ，可以通过串口打印来进行debug，需要把库打印以及相应内置FM驱动底层模块打印打开才会出现。

需在文件`apps\soundbox\include\app_config.h`中`#define LIB_DEBUG    1`

以及`apps\soundbox\log_config\lib_driver_config.c`中`const char log_tag_const_i_FM AT(.LOG_TAG_CONST) = CONFIG_DEBUG_LIB(1);`



### 5.3.2. 内置FM 驱动API函数

```
void fm_inside_io_ctrl(int ctrl, ...);

void fm_inside_default_config(void);//默认配置参数
void fm_inside_mem_init(void);
void fm_inside_on(void);//内置收音初始化
void fm_inside_off(void);//关闭内置收音
u8 fm_inside_freq_set(u32 freq);//设置频点 87.5M 填 87500
void fm_inside_int_set(u8 mute);//中断开关
u16 fm_inside_id_read(void);//获取内置收音的ID
s8 fm_inside_rssi_read(void); //获取电台的功率 -96 ~ 0 dB
u8 fm_inside_st_read(void);//获取电台的声道 1：立体声;  0: 单声道;
s8 fm_inside_cnr_read(void);//获取当前频点的载噪比  dB
void fm_inside_set_stereo(u8 set);  //set[0,128], 0 mono, 128 stereo。0~128对应0~30dB分离度
void fm_inside_set_abw(u8 set);  //audio bandwidth set //set[0,127] <=>2k~16k
void fm_inside_deempasis_set(u8 set);// set[0/1], 0:50us, 1:75us
void fm_inside_agc_set(u8 lpf_gain, u8 lna_atten, u8 lna_en); //配置fm内部增益
```

![img155](/pic/155.png)



### 5.3.3. 设置默认FM收音频点方法

```
clear_all_fm_point();                         //清除FM保存频点
save_fm_point(REAL_FREQ(76));      //874 + 76 = 950 对应95.0Khz
save_fm_point(REAL_FREQ(146));    //874 + 146 = 1020 对应102.0  Khz
```



## 5.4. FAQ

- **AC695/AC696系列FM收音效果差，基本调试思路:**

1、FM匹配物料放FM天线端，用330nH+4.7PF；

![img156](/pic/156.png)

2、功放跑AB类模式，没有其他DC电路干扰；

3、软件开跑RAM的宏，AGC设为-1.；

![img157](/pic/157.png)

![img158](/pic/158.png)

4、电源干净，地回路完整：VBAT、VDDIO的电容地最快最完整回到芯片地，确保地回路的完整性。错误示范及修改：

![img159](/pic/159.png)

![img160](/pic/160.png)

5、如果FM要加三极管放大电路，参考如下：

![img161](/pic/161.png)