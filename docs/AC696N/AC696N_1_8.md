# 8. SD&U盘

MMC卡：MultiMediaCard，多媒体存储卡

SD卡：Secure Digital Memory Card

**大卡区分方式**

![img34](/pic/34.png)

**小卡区分方式**

小的mmc卡有类似和SD卡外观形状一致的。**需要仔细对比：**

1. 正常SD卡比MMC卡厚了0.7mm，外表几乎一样，但是放在一起，用手摸一下能看到厚薄的差别。

1. mmc卡和sd卡的 cmd检测命令不一致。所以如果程序配置SD卡检测方式为cmd检测，会出现无法兼容mmc卡的情况。

   ![img35](/pic/35.png)

1. 所以需要兼容SD卡和mmc卡，SD卡检测方式应选为clk或IO检测。并做以下修改：

   ![img36](/pic/36.png)





## 8.1. SD相关配置

1. SD卡应用相关配置

   ![img37](/pic/37.png)

1. 三种检测方式

   ![img38](/pic/38.png)

1. 流程

​       检测到卡插入或拔出-->触发相应的公共设备事件处理-->解码设备上下线，设备挂载等处理-->设备扫盘



## 8.2. 如何使能MMC卡功能

如果需要支持市场上这种MMC卡程序上需要做以下配置

1、程序上打开MMC卡的配置

SDK\apps\soundbox\log_config\lib_driver_config.c

```
const int sdx_can_operate_mmc_card = 1;
```

2、SD卡的检测改为CLK或者IO检测。不能使用CMD检测

![img39](/pic/39.png)



## 8.3. U盘不读问题处理方法

1、先检查U盘文件系统是否是支持的文件系统。

默认支持 FAT12,FAT16,FAT32,exFAT 

不支持：NTFS

不支持：苹果文件系统

2、常见U盘不读处理方法

有些U盘反应较慢，host过了超时时间会认为U盘没有回应导致不读取U盘，挂载不成功

3、在程序上开启log打印。 

![img40](/pic/40.png)

观察打印有没有出现这个打印

![img41](/pic/41.png)

若有可以修改

![img42](/pic/42.png)

没有改善可以在apps\common\usb\usb_common_def.h文件中修改

![img43](/pic/43.png)

超时时间，复位持续时间，尝试次数加长，以等待slve回应。

4、程序若使能了PC模式，则USB OTG 会第一时间以host端发送数据，若从机没有回应会认为此时应该担任slave的角色。有些U盘会插入后发送信息会较慢，导致USB OTG 认为插入的是主机，从而切换到从机模式，导致U盘不读。

![img44](/pic/44.png)

5、检查下inquery的延时是否正确

apps\common\usb\host\usb_storage.c 文件中的`int usb_stor_init(struct device *device)`，右图为正确修改

![img45](/pic/45.png)



## 8.4.U盘和卡复用相关

1、U盘和卡复用后，默认SDK是不支持卡用CMD检测的（建议使用CLK检测）。若生产出现卡座出问题，无法使用CLK检测。一定要改成CMD检测，需要按以下修改，并多做测试。

![img46](/pic/46.png)

![img47](/pic/47.png)

![img48](/pic/48.png)



## 8.5. 某张TF卡不读，其他TF卡能读

排查思路：

1、软件开打印看一下log

2、排查一下TF卡的供电，用外置3.3V给卡供电是否正常；

3、插卡瞬间，VDDIO的电压是否有被拉低；

4、测试一下，OK卡和NG卡的瞬态工作电流，测试方法如下图：在TF电源串一个小电阻（例如2.7R），然后用示波器挂在电阻两端，测试电阻两端的瞬态压差，然后根据欧姆定律，转换为瞬态电流。

![img49](/pic/49.png)

注意：**不同品牌、不同速度等级、不同存储容量的TF卡，工作电流和额定工作电压是不一样的**

电流大小：低速卡<高速卡<超高速卡，  小容量<大容量；



## 8.6. 大音箱中，TF卡副板与音箱主板排线过长，导致不读卡

1、这类大音箱，一般是使用220V电源板或高压电源供电，电源辐射较强。主副板排线过长容易引入辐射干扰，影响TF卡通信。需要在TF卡副板端的CMD、CLK、DAT这3根数据线上各串一个磁珠（1K@100M）来吸收高频干扰。

2、用示波器测试TF卡插入瞬间，VCC电压是否被拉扯过低(不要低于3V ),若是被拉扯过低，则加大TF卡座电源脚的滤波电容，最大可加到226。

![img50](/pic/50.png)