# 2. IIS音频接口应用

IIS（Inter-IC Sound）是飞利浦推出的数字音频接口标准，专为集成电路间的高质量音频数据传输设计，广泛应用于音频编解码器（CODEC）、微控制器（MCU）、数字信号处理器（DSP）等设备间的音频交互。

## 2.1. 核心作用

IIS 的核心作用是实现数字音频数据的同步传输，其优势包括：

1. 分离的时钟与数据线路，减少信号干扰，保证音频质量；

1. 支持高采样率、高位深度音频传输，满足专业音频需求；

1. 接口时序简单，硬件实现成本低，兼容性强。

   

## 2.2. 接口信号组成

IIS 接口包含 4 路核心信号：

![img63](/pic/63.png)

![img64](/pic/64.png)

- **MCLK（主时钟）**：作为音频 CODEC（编解码器）的基准时钟，用于同步内部数字电路（如数模转换、滤波等），其频率 **是 LRCLK 频率的整数倍**（常见 256/384 倍），倍数由 CODEC 的硬件设计决定。
  - 若音频采样率为 48KHz，配置256倍，则MCLK会输出 48K*256 = 12.288MHz
- **LRCLK（左右声道时钟）**：有的叫**WS（word select）**，用于区分左右声道的数据传输，其频率 **等于音频的采样率（Sample Rate）**。例如：
  - 若音频采样率为 44.1kHz（CD 标准），则 LRCLK 频率为 44.1kHz；
  - 若采样率为 48kHz（常用专业音频），则 LRCLK 频率为 48kHz。

（注：LRCLK 的高低电平分别对应左 / 右声道，具体极性由设备定义，不影响频率关系。）

- **SCLK（Serial Clock，串行时钟）**：也叫位时钟，频率为 LRCLK 的位深度倍数（如 16 位音频对应 LRCLK×16），控制每 bit 数据的传输时序。
  - 若音频采样率为 44.1kHz，位深32位，则 SCLK 频率为2 * 44100 * 32 = 2.8224 MHz；
- **SDATA（Serial Data，串行数据）**：传输数字音频数据，采用二进制补码形式，高位在前，在 SCLK 的特定边沿采样。



## 2.3. 典型应用场景

**64SCLK模式**

![img65](/pic/65.png)

该模式下16bitIIS设备和24bit设备都可以共用数据线进行通信。当外部IIS设备为24BIT模式时，芯片一帧数据只会采集16位音频数据位，后面16位数据位丢弃。当芯片作为输出16BIT数据时，外部需要采集24位音频数据位，当其采集完16位音频高位时，后面采集的低八位全部为0，不影响正常输出。

**32SCLK模式**

![img66](/pic/66.png)



## 2.4. 故障排查

IIS（Inter-IC Sound）音频接口的故障通常表现为**无音频输出 / 输入、音频失真、杂音、数据传输中断**等，排查需从硬件连接、时钟同步、数据格式、软件配置等维度逐步推进，具体步骤如下：

### 2.4.1. 初步故障现象定位

**1、明确故障类型**

- 是 “完全无信号”（如喇叭无声、录音无数据），还是 “信号异常”（如杂音、卡顿、失真）？

- 是单向故障（仅输出 / 仅输入异常），还是双向故障（输出和输入均异常）？

- 记录故障出现的场景（如上电即异常、运行中突发、特定采样率下异常等）？

  

### 2.4.2. 硬件连接与物理层排查

**核心：排除接线错误、接触不良、电源 / 接地问题**

**1、信号线连接检查**

- 核对 MCLK、LRCLK、SCLK、SDATA 的引脚连接是否与设计一致（主设备输出→从设备输入，避免接反）。
- 检查 SDATA 方向是否匹配场景：输出时主设备 SDATA 输出→CODEC SDATA 输入；输入时 CODEC SDATA 输出→主设备 SDATA 输入（部分 CODEC 分 SDIN/SDOUT 引脚，需区分）。
- 排查线路是否松动、虚焊（尤其高频时钟线 MCLK/SCLK，虚焊易导致信号丢失）。

**2、电源与接地检查**

- 测量 CODEC 和主设备的供电电压（如 3.3V/5V）是否稳定，纹波是否过大（用示波器观察，纹波应 < 100mV）。
- 确认主设备与 CODEC 共地（GND 连接可靠），避免 “悬浮地” 导致的信号电平参考不一致（表现为杂音或数据错乱）。

**3、布线干扰排查**

- 检查时钟线（MCLK/LRCLK/SCLK）是否与强干扰源（如电机、开关电源）并行布线，或长度过长）。

- 确认时钟线与数据线（SDATA）是否保持足够间距（至少 2 倍线宽），避免串扰（串扰会导致数据采样错误，表现为杂音）。

  

### 2.4.3. 时钟信号同步性排查

**核心：IIS 依赖严格的时钟同步，时钟异常是最常见故障根源**

**1、时钟频率测量**

- 用示波器测量 MCLK、LRCLK、SCLK 的频率，验证是否符合预设值：
  - LRCLK 频率 ≡ 音频采样率（如 44.1kHz 采样率对应 LRCLK=44.1kHz）；
  - SCLK 频率 = 采样率 × 位深度（如 16bit 对应 SCLK=44.1kHz×16=705.6kHz）；
  - MCLK 频率 = LRCLK × N（N 为 CODEC 要求的倍数，如 256/384，需核对数据手册）。
- 若频率偏差超过 1%（如 44.1kHz LRCLK 实际为 43kHz），会导致采样错位，表现为失真或无声。

参考：SCLK示波器捕捉波形 44.1kHz，位深32位，则 SCLK 频率为2 * 44100 * 32 = 2.8224 MHz

![img67](/pic/67.png)

**2、时钟波形质量检查**

- 用示波器观察时钟信号的上升沿 / 下降沿是否陡峭（过冲 < 10%，毛刺 < 50mV），避免因线路阻抗不匹配导致的波形畸变（畸变会导致从设备采样错误）。
- 检查 MCLK 是否稳定（无突然中断或频率跳变），MCLK 丢失会导致 CODEC 内部电路停摆，直接无输出。

**3、时钟源一致性验证**

- 确认主设备的时钟源（如 PLL、外部晶振）是否稳定，若主设备时钟由软件动态调整，需排查是否存在配置错误（如分频系数计算错误）。

- 若 CODEC 支持 “内部时钟” 模式，需确认是否误将其配置为 “外部时钟”（或反之），导致时钟源冲突。

  

### 2.4.4. 数据传输与格式排查

**核心：验证 SDATA 的数据格式、时序是否与配置一致**

**1、数据格式匹配性检查**

- 核对主设备与 CODEC 的配置是否统一：
  - 位深度（16bit/24bit/32bit）是否一致（如主设备发 24bit 数据，CODEC 配置为 16bit，会导致数据截断或错位）；
  - 数据格式（IIS 标准格式 / 左对齐 / 右对齐）是否一致（格式不匹配会导致声道反相或数据错误，表现为杂音）；
  - 采样边沿（SCLK 上升沿采样 / 下降沿采样）是否匹配（由 CODEC 数据手册定义，主设备需同步配置）。

**2、SDATA 信号抓取与分析**

- 用逻辑分析仪或示波器同时抓取 SDATA、LRCLK、SCLK 信号，分析：
  - 每个声道的数据是否在 LRCLK 的对应电平周期内传输（如左声道在 LRCLK 高电平，右声道在低电平）；
  - 数据位是否与 SCLK 严格同步（1 个 SCLK 周期传输 1bit，高位在前）；
  - 有无连续无效数据（全 0 或全 1，可能是主设备未正确发送数据，或 CODEC 未正确接收）。

**3、单向传输故障细化**

- 若仅输出异常：检查主设备是否正确输出 SDATA（用逻辑分析仪看是否有数据变化），CODEC 的 DAC 模块是否使能（寄存器配置）；
- 若仅录音异常：检查 CODEC 的 ADC 模块是否使能，主设备是否正确配置为 “接收模式”，SDATA 是否有来自 CODEC 的信号。



### 2.4.5. 软件配置与初始化排查

**核心：排除寄存器配置错误、初始化流程遗漏**



### 2.4.6 替换法与极端排查

若以上步骤未解决问题，采用替换法排除硬件故障：

1. **替换连接线**：用已知良好的短线替换现有线路，排除线缆干扰或损坏；
1. **替换 CODEC**：用同型号正常芯片替换，排除 CODEC 硬件损坏（如内部 DAC 故障）；
1. **替换主设备**：在开发板上搭建最小系统（如 MCU+CODEC + 喇叭），验证是否为主设备 IIS 控制器故障；
1. **降低参数测试**：尝试降低采样率（如从 192kHz 降至 44.1kHz）、减少位深度（如 32bit→16bit），排查高参数下的时钟稳定性问题。

**总结排查优先级**

1. 先查**硬件连接与电源**；
1. 再查**时钟频率与同步**；
1. 然后查**数据格式与软件配**；
1. 最后用**替换法排除硬件损**。



## 2.5. AC696 - AUDIO IIS

### 2.5.1. 接口定义

1. 接信号有 MCLK ，SCLK ， LRCK ，DATA。 支持 基本模式  IIS/左对齐/右对齐 ，拓展模式右DSP0/DSP1。 
1. ALNK 具备有4条独立的通道，可以相互独立工作，每条通道都可独立配置为输入或输出，也可配置为不同的连接模式（主从模式），需要注意的是4个通道均共用了MCLK/SCLK/LRCK信号，因此有一定的局限性。

​	（1）基本模式下只支持双声道立体声。

​	（2）4条通道只能同时工作于基本模式，或同时工作于拓展模式，不支持混合模式。

![img68](/pic/68.png)



### 2.5.2. 驱动

AUDIO IIS的驱动文件路径在：

..\cpu\br25\audio_common\audio_link.c

..\cpu\br25\audio_common\audio_link.h

..\include_lib\driver\cpu\br25\asm\iis.h

```
typedef enum {
    ALINK_SR_48000 = 48000,
    ALINK_SR_44100 = 44100,
    ALINK_SR_32000 = 32000,
    ALINK_SR_24000 = 24000,
    ALINK_SR_22050 = 22050,
    ALINK_SR_16000 = 16000,
    ALINK_SR_12000 = 12000,
    ALINK_SR_11025 = 11025,
    ALINK_SR_8000  = 8000,
} ALINK_SR;

//===================================//
//多个通道使用需要注意:
//1.数据位宽需要保持一致
//2.buf长度相同
//===================================//
typedef struct _ALINK_PARM {
    u8 port_select;
    struct alnk_ch_cfg ch_cfg[4];        //通道内部配置
    ALINK_MODE mode;                     //IIS, left, right, dsp0, dsp1
    ALINK_ROLE role;             //主机/从机
    ALINK_CLK_MODE clk_mode;             //更新和采样边沿
    ALINK_DATA_WIDTH  bitwide;   //数据位宽16/32bit
    ALINK_FRAME_MODE sclk_per_frame;      //32/64 sclk/frame
    u16 dma_len;                         //buf长度: byte
    ALINK_SR sample_rate;                    //采样率
} ALINK_PARM;
ALINK_PARM    test_alink = {
    .port_select = ALINK0_PORTA,            //MCLK:PA2 SCLK:PA3  LRCK:PA4 CH0:PA0 CH1:PA1 CH2:PA5 CH3:PA6
    /* .port_select = ALINK0_PORTB,            //MCLK:PC2 SCLK:PA5  LRCK:PA6 CH0:PA0 CH1:PA2 CH2:PA3 CH3:PA4 */
    .ch_cfg[0].enable = 1,
    .ch_cfg[1].enable = 1,
    .mode = ALINK_MD_IIS,
    /* .role = ALINK_ROLE_SLAVE, */
    .role = ALINK_ROLE_MASTER,
    .clk_mode = ALINK_CLK_FALL_UPDATE_RAISE_SAMPLE,
    .bitwide = ALINK_LEN_16BIT,
    .sclk_per_frame = ALINK_FRAME_64SCLK,
    /* .sclk_per_frame = ALINK_FRAME_32SCLK, */
    .dma_len = ALNK_BUF_POINTS_NUM * 2 * 2 * 2,
    .sample_rate = 44100,
};
```



### 2.5.3. 使能IIS

对应的板级配置 选择 AUDIO_OUTPUT_WAY = AUDIO_OUTPUT_WAY_IIS 或 AUDIO_OUTPUT_WAY_DAC_IIS ，会使能 TCFG_IIS_ENABLE ，可以实现IIS输出到DAC的功能

![img69](/pic/69.png)



## 2.6. FAQ

**1、如何关闭MCLK时钟**

`int alink_init(ALINK_PARM *parm)`中会使能 MCLK 时钟，把对应的代码注释掉即可

![img70](/pic/70.png)

**2、手机打开音量同步时会出现设置音量声音大小没有变化**

输出方式设置为AUDIO_OUTPUT_WAY_DAC_IIS情况下

![img71](/pic/71.png)

![img72](/pic/72.png)

**3、IIS输入时没有声音，首先检查引脚接线、采样率、主从机、数据采样沿是否配置正确**

![img73](/pic/73.png)

![img74](/pic/74.png)

![img75](/pic/75.png)

**4、IIS输入输出如何兼容24BIT功放或数据**

IIS本身就带有上下兼容数据的功能，只需要配置64SCLK模式和16BIT即可。具体原因可以看数据分析的64SCLK模式。

![img76](/pic/76.png)

