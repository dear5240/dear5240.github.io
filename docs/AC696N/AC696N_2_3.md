# 3.SPDIF模式相关（HDMI_ARC、光纤、同轴）

## 3.1. 三种输入简介

**SPDIF信号介绍：**[SPDIF接口详解](https://blog.csdn.net/u011393762/article/details/121093307)

### 3.1.1. HDMI_ARC输入

**参考硬件原理图：**

![img77](/pic/77.png)

**程序配置：**

**根据硬件配置口：**

1、CEC，SPDIF是必须的，硬件需要与程序配置一致；

CEC口：普通IO口即可

SPDIF口：根据数据手册选配

![img78](/pic/78.png)

2、HDMI_DET，IIC接口可以选配，

​     **HDMI_DET：**插入检测，检测到HDMI端口插入后重启CEC初始化（也可以拔出退出spdif模式，插入则跳转到spdif模式），可以避免热拔插后无声

​     HDMI_DET功能可以参考程序LINEIN检测的流程

​     **IIC接口：**获取电视HDMI接到机器的端口号，一般电视都会通过IIC下发端口号，有些电视（测试过一台小米电视）会通过CEC读取机器从IIC获取到的端口号，读取错误直接无音频数据，为了提高兼容性建议加

   【金山文档】 hdmi_dcc(IIC部分程序，具体添加可以参考下文DEMO程序)

​     [hdmi_dcc.c](https://www.kdocs.cn/view/l/ctTGHQMRNWto)

![img79](/pic/79.png)

**注意点：**

1. IIC口可以选配，有IIC接口可以增加兼容性，建议加上(备注)；
1. 程序注释的硬件IIC接口有可能CLK,DAT脚是相反的，建议看芯片datasheet，或者直接使用软件IIC功能；
1. 建议加入插入检测，参照linein插入检测添加，在拔出时退出spdif模式，插入时重新进入spdif模式，主要是重新初始化CEC，避免有些拔出后电视发CEC指令长时间不回导致的重新插入HDMI无声



**HDMI-ARC一般调试步骤：**

**硬件调试：**

1. 参考AC6954A公版原理图，检查硬件电路设计是否正确；

   [AC6954A光纤铜轴HDMI原理图](https://www.kdocs.cn/l/cvjeuq6ixfmT?openfrom=docs)

1. 检查样机的物料焊接是否正常：①HDMI母座各引脚；②SN74LVC2G04反相器有无焊反；③其他物料是否漏贴或贴错，线路正常导通；④如有FPC排线，检查是否正常导通；⑤反相器电源供电不稳（电源负载能力不足），用外挂LDO-3.3V供电，反相器电源脚加有滤波电容。

1. 用示波器或逻辑分析仪测量如下图标的8个点的信号是否正常：(重点关注：2点和8点的信号)

> 注意：如果“2点-ARC”引脚没有信号波形出来，就是软件通信不成功，先检查软件。“2点-ARC”信号波形如下：

![img80](/pic/80.png)

HDMI正常连接播放时，8个点的信号如下：

1-CEC：正常的能看到打印，如果无打印的话抓波形，建议使用逻辑分析仪抓波形，然后解析，开机进spdif模式时会有一串CEC波形，说明IO口配置正确。

如果打印没有cec command检查硬件电视端的CEC口到板子之间的导通情况

cec波形：

![img81](/pic/81.png)

![img82](/pic/82.png)

2-ARC：cec通信正常后，电视才会输出信号，电视直接给的信号幅度不够，所以要加反相器等放大处理

![img83](/pic/83.png)

3，4点：为IIC引脚，为软件IIC，可以查看打印或者接逻辑分析仪分析是否有问题

5点：5V

6点：DET脚，HDMI_ARC在线为高电平。插入HMDI线连接电视，DET脚会有5V的电平出来，如果使用非高压口，需要用10K和20K电阻做一个分压给到主控IO口，不能直接5V倒灌进主控。

8-反相器输出：ARC信号经过反相器放大到幅值为3.3V的数字信号

![img84](/pic/84.png)

![img85](/pic/85.png)

![img86](/pic/86.png)



**软件调试：**

**1. 打开打印，查看程序是否有跑到cec command,验证是否CEC接线以及通信正常,如果没有出现cec command,则需要检测CEC线是否接好**

![img87](/pic/87.png)

**2. 添加IIC这块后，查看IIC的通信是否正常**

![img88](/pic/88.png)

**红圈圈出为HDMI的端口号，一般为0x10,0x20,0x30;出现异常检查IIC接线问题，看注意点第二点**

**3. 前两点正常的情况下，一般能进入到SPDIF解码播放的过程，出现如下打印内容**

![img89](/pic/89.png)

**如果出现此情况打印则检查电视是否为PCM格式输出，目前SDK只支持此格式：**

![img90](/pic/90.png)

如果出现此情况打印，是由于**硬件接收到的数据量跟目前的采样率不符合**导致，需要检测硬件接线是否正确，反相器供电是否被喇叭拉低等

![img91](/pic/91.png)



**HDMI_ARC扩展知识**

**1. HDMI_ARC功能介绍**

[HDMI ARC 功能分析与协议打通过程](https://zhuanlan.zhihu.com/p/80772947)

**2. 常见CEC command解释**

[HDMI-CEC功能之System Audio Control](https://blog.csdn.net/weixin_43442683/article/details/107376618)

**3. HDMI_ARC相关功能调试**

**(1) 音量同步**

![img92](/pic/92.png)

第三个数据为电视总音量的百分比，根据实际要求可以通过cec发送数据来实现对电视机音量的控制

（同时也可以通过发送0xB2来实现电视的静音，如过关闭静音只需要发送电视音量百分比到电视实现设置音量并解除静音）



下面是实现音量同步以及开关静音的相关例子

![img93](/pic/93.png)

**(2) 同步开关机**

一些电视关机的时候会通过cec发送关机指令过来，但是有一些不会，但都会有待机指令过来，我们可以通过待机指令来同步关闭音箱

![img94](/pic/94.png)

电视关机或者进入待机，电视机都会发送一个广播信息过来（0x0f , 0x36)

![img95](/pic/95.png)

**(3) 退出HDMI_ARC需要注意的地方**

退出HDMI_ARC时，需要做释放，不然电视机的声音输出一直会在ARC模式，电视机本身的扬声器就不会有声音出来，要人为手动去重新选择音频输出

先发送关闭cec控制命令，最后设置cec为高阻态

![img96](/pic/96.png)

注意：这样直接发送关闭cec控制到电视，一些电视会存在，二次进入hdmi的时候会没声音处理方法如下，初始化完cec发送一下命令：

![img97](/pic/97.png)



### 3.1.2. 光纤输入

**参考硬件原理图：**

![img98](/pic/98.png)

**程序配置：**

**AC696硬件配置口:**

![img99](/pic/99.png)

注意点：

1. 程序注意配置对口即可，出问题时先量配置的口有无输入，无输入则检查硬件
1. 光纤接收头输出的电平幅度与接收头的电源接近。

![img101](/pic/101.png)



### 3.1.3. 同轴输入

**参考硬件原理图：**

![img100](/pic/100.png)

**程序配置**

**AC696硬件配置口：**

![img99](/pic/99.png)

注意点：

1. 程序注意配置对口即可，出问题时先量配置的口有无输入，无输入则检查硬件



## 3.2. 各类功能介绍

**1. 播放暂停功能**

```
    case KEY_MUSIC_PP:
        if(music_pp_flag == 0){
            audio_spdif_slave_close(&spdif_slave_hdl);
            music_pp_flag = 1;
        }
        else{
            music_pp_flag = 0;
            audio_spdif_slave_open(&spdif_slave_hdl);
            audio_spdif_slave_start(&spdif_slave_hdl);
        }
        break;
```



## 3.3. 问题解决

**1. SPDIF切换端口失败问题**

```
        audio_spdif_slave_close(&spdif_slave_hdl);
        spdif_slave_hdl.input_port  = SPDIF_IN_PORT_A;
        audio_spdif_slave_open(&spdif_slave_hdl);
        audio_spdif_slave_start(&spdif_slave_hdl);
//通过重启SPDIF解码的方式解决，替代原先的：audio_spdif_slave_switch_port(&spdif_slave_hdl, SPDIF_IN_PORT_A);函数
```



**2. 连接HDMI-ARC后遥控无法控制电视音量问题**

此问题原因：电视接收遥控红外信号后，固定了电视自身的数据输出，通过发送CEC command给机器，希望机器端判断command来进行+-音量操作。

一般打印如下：

![img102](/pic/102.png)

命令意义:

![img103](/pic/103.png)

05 44 41:音量+

05 44 42:音量-

05 45     :音量控制停止

获取到这些cmd后，解析判断然后控制音箱+-音量即可



**常见CEC command解释：**

[HDMI-CEC功能之System Audio Control](https://blog.csdn.net/weixin_43442683/article/details/107376618)

[HDMI-CEC特性之ARC消息含义](https://blog.csdn.net/weixin_43442683/article/details/107321641)