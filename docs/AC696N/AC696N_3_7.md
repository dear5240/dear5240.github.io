# 7. 录音相关应用

## 7.1. 内部flash录音

**1、打开相应的宏配置**

打开对应的宏(***FLASH_INSIDE_REC_ENABLE***)即可跑相应的录音。

```
//*********************************************************************************//
//                                 fat_FLASH 配置                                      //
//*********************************************************************************//
#define TCFG_CODE_FLASH_ENABLE				DISABLE_THIS_MOUDLE

#define FLASH_INSIDE_REC_ENABLE             1

#if  TCFG_NORFLASH_DEV_ENABLE
#define TCFG_NOR_FAT                    0//ENABLE
#define TCFG_NOR_FS                     1//ENABLE
#define TCFG_NOR_REC                    0//ENABLE

注意：
    修改TCFG_NOR_FS=1后，提示音路径跟着改变，所以会出现没有提示音的情况，修改如下：
#if (0) && TCFG_NOR_FS && (TCFG_VIRFAT_FLASH_ENABLE == 0)
#define NOR_FLASH_RES_ROOT_PATH     "storage/res_nor/C/"
#define TONE_RES_ROOT_PATH         NOR_FLASH_RES_ROOT_PATH    //内置flash提示音根路径
#else
#define TONE_RES_ROOT_PATH         SDFILE_RES_ROOT_PATH       //内置flash提示音根路径
#endif//TCFG_NOR_FS
```

![img178](/pic/178.png)

**1、录音区的大小**

起始地址由工程自动分配， 大小设置如下：

![img179](/pic/179.png)

具体文件如下,在 ini 配置中配置给录音的最大容量（REC_LEN）

```
EXIF_ADR=AUTO;
EXIF_LEN=0x1000;
EXIF_OPT=1;

#WTIF_ADR=BEGIN_END;
#WTIF_LEN=0x1000;
#WTIF_OPT=1;

REC_ADR=AUTO;
REC_LEN=64K;
REC_OPT=1;

PRCT_ADR=0;
PRCT_LEN=CODE_LEN;
PRCT_OPT=2;
```

> apps\common\dev_manager\dev_manager.c 上设置实际需要的大小， 如果大于最大容量， 会报错。

```
#if FLASH_INSIDE_REC_ENABLE
    set_rec_capacity(64*1024);//需要先设置容量,注意要小于Ini文件设置大小.
    _sdfile_rec_init();
	dev_manager_add("rec_sdfile");
#endif
```

内置flash录音 注意点：

1. 录音时间长短 取决于 录音空间大小和录音的采样率，码率，录音格式三个因素
1. 由于录音数据会存放到flash的操作中会关闭总中断，中断优先级<6的中断都会被屏蔽，这样会导致录音采集MIC信号时候，由于关闭总中断的操作，可能会出现丢帧的情况

改善方式是

1、增加一次MIC中断的数据点数大小，减少由于上述操作导致的丢帧情况。不过这样会占用非常大的RAM空间

![img180](/pic/180.png)

2、减少录音的采样率和码率

处理案例：

- 696系列由于部分芯片是256 擦除的内置flash，所以需要修改兼容256擦除，合并补丁如下：

[AC696N&AC608N_内置flash录音修改补丁(兼容256K擦除&&播放卡顿)](https://www.kdocs.cn/view/l/claW5hb6Z1bY?openfrom=docs)



## 7.2. 外置flash录音

**1、打开相应的宏配置**

打开对应的宏即可跑相应的录音。

- 打开外挂flash的宏定义

```
//*********************************************************************************//
//                                 FLASH 配置                                      //
//*********************************************************************************//
#define TCFG_NORFLASH_DEV_ENABLE		    0//DISABLE_THIS_MOUDLE //需要关闭SD0
#define TCFG_FLASH_DEV_SPI_HW_NUM			1// 1: SPI1    2: SPI2
#define TCFG_FLASH_DEV_SPI_CS_PORT	    	IO_PORTC_03
```

- flash分区说明:

TCFG_NOR_FAT: 类似U盘，实现fat文件系统播歌

TCFG_NOR_FS：实现提示音资源放在外挂flash

TCFG_NOR_REC：实现外挂flash的录音

```
//*********************************************************************************//
//                                 fat_FLASH 配置                                      //
//*********************************************************************************//
#define TCFG_CODE_FLASH_ENABLE				DISABLE_THIS_MOUDLE

#define FLASH_INSIDE_REC_ENABLE             0

#if  TCFG_NORFLASH_DEV_ENABLE
#define TCFG_NOR_FAT                    0//ENABLE
#define TCFG_NOR_FS                     0//ENABLE
#define TCFG_NOR_REC                    1//ENABLE
```

**2、录音区的大小**

留意以下两个变量的设置

![img181](/pic/181.png)

> 程序上设置实际需要的大小， 如果大于最大容量或者空间重叠， 会复位。

SDK\apps\soundbox\board\br25\板级.c

```
#if TCFG_NOR_FAT
NORFLASH_DEV_PLATFORM_DATA_BEGIN(norflash_fat_dev_data)
    .spi_hw_num     = TCFG_FLASH_DEV_SPI_HW_NUM,
    .spi_cs_port    = TCFG_FLASH_DEV_SPI_CS_PORT,
#if (TCFG_FLASH_DEV_SPI_HW_NUM == 1)
    .spi_pdata      = &spi1_p_data,
#elif (TCFG_FLASH_DEV_SPI_HW_NUM == 2)
    .spi_pdata      = &spi2_p_data,
#endif
    .start_addr     = 0,
    .size           = 1*1024*1024,
NORFLASH_DEV_PLATFORM_DATA_END()
#endif

#if TCFG_NOR_FS
NORFLASH_DEV_PLATFORM_DATA_BEGIN(norflash_norfs_dev_data)
    .spi_hw_num     = TCFG_FLASH_DEV_SPI_HW_NUM,
    .spi_cs_port    = TCFG_FLASH_DEV_SPI_CS_PORT,
#if (TCFG_FLASH_DEV_SPI_HW_NUM == 1)
    .spi_pdata      = &spi1_p_data,
#elif (TCFG_FLASH_DEV_SPI_HW_NUM == 2)
    .spi_pdata      = &spi2_p_data,
#endif
    /* .start_addr     = 1*1024*1024, */
    .start_addr     = 0,
    .size           = 4*1024*1024,
NORFLASH_DEV_PLATFORM_DATA_END()
#endif

#if TCFG_NOR_REC
NORFLASH_DEV_PLATFORM_DATA_BEGIN(norflash_norfs_rec_dev_data)
    .spi_hw_num     = TCFG_FLASH_DEV_SPI_HW_NUM,
    .spi_cs_port    = TCFG_FLASH_DEV_SPI_CS_PORT,
#if (TCFG_FLASH_DEV_SPI_HW_NUM == 1)
    .spi_pdata      = &spi1_p_data,
#elif (TCFG_FLASH_DEV_SPI_HW_NUM == 2)
    .spi_pdata      = &spi2_p_data,
#endif
    .start_addr     = 2*1024*1024,
    .size           = 2*1024*1024,
NORFLASH_DEV_PLATFORM_DATA_END()
#endif
```



## 7.3. 暂停录音操作(获取录音buf处)

这里可以增加一个标志位， 如果是暂停的状态， 这个cbuf不写即cbuf_write函数不执行即可，示例如下：

![img182](/pic/182.png)

备注：此处也是录音数据写入的地方，可以在此处处理写入的数据。

